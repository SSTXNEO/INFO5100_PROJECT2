<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>try2</title>
    <script src="./d3.js"></script>

    <style>
      .orbit {
        stroke : #000000;
        fill : none;
      }
      .planet {
        stroke : #000000;
        fill : #FFFFFF;
      }
      .sun {
        stroke : #000000;
        fill : #000000;
      }
    </style>

  </head>
  <body>

    <div id="planetarium">
    </div>

    <script type="text/javascript">
      var w = 1440, h = 900;
      var t0 = Date.now();
      var svg = d3.select("#planetarium").insert("svg")
        .attr("width", w).attr("height", h).attr("id","canvas").attr("transform","translate(100,100)");

      svg.append("circle").attr("r", 20).attr("cx", w/2)
        .attr("cy", h/2).attr("class", "sun");

      var container = svg.append("g")
          .attr("class","spinner")
        .attr("transform", "translate(" + w/2 + "," + h/2 + ")");
      var parseTime = d3.timeParse("%d-%b-%Y");
      var formatYear=d3.timeFormat("%Y");
      var inter=d3.scaleTime().domain([parseTime("01-Jan-1937"),parseTime("12-Dec-2020")]).range([100, 400]);
      var speedScale=d3.scaleLinear().domain([120908074,1000000000]).range([5,1]);
      function parseline(line){
        return {
            time:parseTime(line.year),
            box_office:+line.box_office,
            if_female:+line.female_lead,
            if_black:+line.non_white_lead,
            radiusOrbit:inter(parseTime(line.year)),
            radiusDot:5,
            speed:speedScale(line.box_office),
            phi0: Math.floor(360*Math.random())
        }
      }
      d3.csv("./movie_actor.csv",parseline,function(data) {
          var planets = [];
          data.forEach(function (d) {
              planets.push({
                  time:d.time,
                  R: d.radiusOrbit,
                  r: d.radiusDot,
                  speed: d.speed,
                  phi0: d.phi0,
                  if_female: d.if_female,
                  if_black: d.if_black
              });
          });
//          console.log(planets);
//          var test=[];
          container.selectAll("g.planet").data(planets).enter().append("g")
              .attr("class", "planet").each(function (d, i) {
              d3.select(this).append("circle").attr("class", "orbit")
                  .attr("r", d.R)
                  .style("stroke", "none");

              if (d.if_female === 1 || d.if_black === 1) {
                  d3.select(this).append("circle").attr("r", d.r).attr("cx", d.R)
                      .attr("cy", 0).attr("class", "planet minority").style("fill", "#ff8004");
              }
              else {
                  d3.select(this).append("circle").attr("r", d.r).attr("cx", d.R)
                      .attr("cy", 0).attr("class", "planet");
              }
//              test.push(formatYear(d.time));
          });
//          console.log(test);
            var j=0;
          d3.select("svg#canvas")
              .on("click",function(){
                  console.log(j);
                  if(j%2===0){
                      j=j+1;
                      container.selectAll("g.planet").data(planets)
                      .each(function(d){
                          d.speed=d.speed/5;
                      });
                  }
                  else{
                      j=j+1;
                      container.selectAll("g.planet").data(planets)
                      .each(function(d){
                          d.speed=d.speed*5;
                      });
                  }
              })
              ;

          d3.timer(function () {
              var delta = (Date.now() - t0);

              svg.selectAll(".planet")
                  .attr("transform", function (d) {
                      return "rotate(" + d.phi0 + delta * d.speed / 200 + ")";
                  });
          });
      });


    </script>


  </body>

</html>